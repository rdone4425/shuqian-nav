<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æŸ¥é€šçŸ¥ - ä¹¦ç­¾å¯¼èˆª</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/notifications-enhanced.css">
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€çš„å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ””</span>
                    <h1 class="logo-text">æ£€æŸ¥é€šçŸ¥</h1>
                </div>

                <!-- ç»Ÿä¸€çš„åŠŸèƒ½æŒ‰é’®ç»„ -->
                <div class="header-actions">
                    <!-- å·¥å…·èœå• -->
                    <div class="action-group tools-menu">
                        <button id="toolsMenuToggle" class="action-btn-icon menu-toggle" title="å·¥å…·èœå•">
                            <span class="btn-icon">ğŸ› ï¸</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="toolsDropdown" class="dropdown-menu">
                            <a href="/" class="dropdown-item">
                                <span class="item-icon">ğŸ </span>
                                <div class="item-content">
                                    <span class="item-text">é¦–é¡µ</span>
                                    <span class="item-desc">è¿”å›ä¹¦ç­¾é¦–é¡µ</span>
                                </div>
                            </a>
                            <a href="/token.html" class="dropdown-item">
                                <span class="item-icon">ğŸ”‘</span>
                                <div class="item-content">
                                    <span class="item-text">APIä»¤ç‰Œ</span>
                                    <span class="item-desc">ç®¡ç†è®¿é—®ä»¤ç‰Œ</span>
                                </div>
                            </a>
                            <a href="/link-checker.html" class="dropdown-item">
                                <span class="item-icon">ğŸ”—</span>
                                <div class="item-content">
                                    <span class="item-text">é“¾æ¥æ£€æŸ¥</span>
                                    <span class="item-desc">æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§</span>
                                </div>
                            </a>
                            <a href="/deleted-bookmarks.html" class="dropdown-item">
                                <span class="item-icon">ğŸ—‘ï¸</span>
                                <div class="item-content">
                                    <span class="item-text">åˆ é™¤è®°å½•</span>
                                    <span class="item-desc">æŸ¥çœ‹å’Œæ¢å¤åˆ é™¤çš„ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <a href="/import.html" class="dropdown-item">
                                <span class="item-icon">ğŸ“¥</span>
                                <div class="item-content">
                                    <span class="item-text">å¯¼å…¥ä¹¦ç­¾</span>
                                    <span class="item-desc">ä»æ–‡ä»¶å¯¼å…¥ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <div class="dropdown-divider"></div>
                            <button id="changePasswordBtn" class="dropdown-item">
                                <span class="item-icon">ğŸ”</span>
                                <div class="item-content">
                                    <span class="item-text">ä¿®æ”¹å¯†ç </span>
                                    <span class="item-desc">æ›´æ”¹ç®¡ç†å‘˜å¯†ç </span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="notifications-container">
            <!-- æ±‡æ€»ä¿¡æ¯ -->
            <div id="summaryCard" class="notification-card">
                <h2>ğŸ“Š æ£€æŸ¥æ±‡æ€»</h2>
                <div class="notification-stats">
                    <div class="stat-group">
                        <span class="stat-icon">ğŸ“Š</span>
                        <span class="stat-text">æ€»æ£€æŸ¥æ¬¡æ•°</span>
                        <span id="totalChecks" class="stat-value">0</span>
                    </div>
                    <div class="stat-group">
                        <span class="stat-icon">ğŸ—‘ï¸</span>
                        <span class="stat-text">ç´¯è®¡åˆ é™¤</span>
                        <span id="totalDeleted" class="stat-value">0</span>
                    </div>
                    <div class="stat-group">
                        <span class="stat-icon">ğŸ•’</span>
                        <span class="stat-text">æœ€åæ£€æŸ¥</span>
                        <span id="lastCheckTime" class="stat-value">-</span>
                    </div>
                </div>
            </div>

            <!-- é€šçŸ¥åˆ—è¡¨ -->
            <div class="notification-card">
                <div class="notification-card-header">
                    <h2 class="notification-card-title">ğŸ”” æ£€æŸ¥é€šçŸ¥è®°å½•</h2>
                    <button onclick="loadNotifications()" class="btn btn-secondary">
                        <span class="btn-icon">ğŸ”„</span>
                        åˆ·æ–°
                    </button>
                </div>
                
                <div id="notificationsList">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è®¾ç½®å®šæ—¶æ£€æŸ¥è¯´æ˜ -->
            <div class="notification-card">
                <h2 class="notification-card-title">âš™ï¸ å®šæ—¶æ£€æŸ¥è®¾ç½®</h2>
                <div class="notification-content">
                    <div class="notification-description">
                        <h3>å¦‚ä½•å¯ç”¨æ¯å‘¨è‡ªåŠ¨æ£€æŸ¥</h3>
                        <ol>
                            <li><strong>Cloudflare Cronè§¦å‘å™¨</strong>ï¼ˆæ¨èï¼‰ï¼š
                                <ul>
                                    <li>åœ¨Cloudflare Pagesé¡¹ç›®ä¸­é…ç½®Cronè§¦å‘å™¨</li>
                                    <li>è®¾ç½®è§¦å‘URLï¼š<code>/api/cron/weekly-check</code></li>
                                    <li>è®¾ç½®æ—¶é—´ï¼šæ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹ <code>0 2 * * 0</code></li>
                                    <li>æ·»åŠ Authorizationå¤´ï¼š<code>Bearer your-cron-secret</code></li>
                                </ul>
                            </li>
                            <li><strong>å¤–éƒ¨å®šæ—¶æœåŠ¡</strong>ï¼š
                                <ul>
                                    <li>ä½¿ç”¨GitHub Actionsã€Jenkinsç­‰å®šæ—¶è°ƒç”¨API</li>
                                    <li>POSTè¯·æ±‚åˆ°ï¼š<code>https://your-domain.com/api/cron/weekly-check</code></li>
                                    <li>æ·»åŠ Authorizationå¤´è¿›è¡ŒéªŒè¯</li>
                                </ul>
                            </li>
                        </ol>
                        
                        <h3>ç¯å¢ƒå˜é‡é…ç½®</h3>
                        <p>åœ¨Cloudflare Pagesç¯å¢ƒå˜é‡ä¸­æ·»åŠ ï¼š</p>
                        <ul>
                            <li><code>CRON_SECRET</code>ï¼šå®šæ—¶ä»»åŠ¡éªŒè¯å¯†é’¥</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils/api.js"></script>
    <script>
        // å·¥å…·èœå•åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const toolsMenuToggle = document.getElementById('toolsMenuToggle');
            const toolsDropdown = document.getElementById('toolsDropdown');

            if (toolsMenuToggle && toolsDropdown) {
                // åˆ‡æ¢ä¸‹æ‹‰èœå•
                toolsMenuToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toolsDropdown.classList.toggle('show');
                    toolsMenuToggle.classList.toggle('active');
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                document.addEventListener('click', (e) => {
                    if (!toolsMenuToggle.contains(e.target) && !toolsDropdown.contains(e.target)) {
                        toolsDropdown.classList.remove('show');
                        toolsMenuToggle.classList.remove('active');
                    }
                });

                // ä¿®æ”¹å¯†ç æŒ‰é’®äº‹ä»¶
                const changePasswordBtn = document.getElementById('changePasswordBtn');
                if (changePasswordBtn) {
                    changePasswordBtn.addEventListener('click', () => {
                        // é‡å®šå‘åˆ°é¦–é¡µå¹¶è§¦å‘å¯†ç ä¿®æ”¹æ¨¡æ€æ¡†
                        window.location.href = '/?action=change-password';
                    });
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½é€šçŸ¥
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            
            await loadNotifications();
        });

        async function loadNotifications() {
            try {
                const response = await API.get('/api/cron/weekly-check');
                if (response.success) {
                    displayNotifications(response.data);
                    updateSummary(response.data);
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('åŠ è½½é€šçŸ¥å¤±è´¥:', error);
                document.getElementById('notificationsList').innerHTML = 
                    '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        function displayNotifications(notifications) {
            const notificationsList = document.getElementById('notificationsList');
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<div class="empty-state">æš‚æ— æ£€æŸ¥é€šçŸ¥è®°å½•</div>';
                return;
            }

            notificationsList.innerHTML = notifications.map(notification => {
                const isAuto = notification.type === 'weekly_auto_check';
                const hasDeleted = notification.deletedBookmarks && notification.deletedBookmarks.length > 0;
                
                return `
                    <div class="notification-item">
                        <div class="notification-type ${isAuto ? 'type-auto' : 'type-manual'}">
                            ${isAuto ? 'è‡ªåŠ¨æ£€æŸ¥' : 'æ‰‹åŠ¨æ£€æŸ¥'}
                        </div>
                        
                        <div class="notification-header">
                            <div class="notification-title">
                                ${isAuto ? 'ğŸ¤– æ¯å‘¨è‡ªåŠ¨æ£€æŸ¥' : 'ğŸ‘¤ æ‰‹åŠ¨é“¾æ¥æ£€æŸ¥'}
                            </div>
                            <div class="notification-time">
                                ${new Date(notification.checkedAt).toLocaleString()}
                            </div>
                        </div>
                        
                        <div class="notification-stats">
                            <span class="stat-item stat-total">æ€»è®¡: ${notification.total}</span>
                            <span class="stat-item stat-accessible">å¯è®¿é—®: ${notification.accessible}</span>
                            <span class="stat-item stat-error">ä¸å¯è®¿é—®: ${notification.inaccessible}</span>
                            ${notification.deleted ? `<span class="stat-item stat-deleted">å·²åˆ é™¤: ${notification.deleted}</span>` : ''}
                        </div>
                        
                        ${hasDeleted ? `
                            <div class="deleted-bookmarks">
                                <h4>ğŸ—‘ï¸ å·²åˆ é™¤çš„ä¹¦ç­¾ (${notification.deletedBookmarks.length}ä¸ª)</h4>
                                ${notification.deletedBookmarks.slice(0, 5).map(bookmark => `
                                    <div class="deleted-bookmark">
                                        <div class="deleted-bookmark-title">${bookmark.title}</div>
                                        <div class="deleted-bookmark-url">${bookmark.url}</div>
                                        <div class="deleted-bookmark-reason">åˆ é™¤åŸå› : ${bookmark.reason}</div>
                                    </div>
                                `).join('')}
                                ${notification.deletedBookmarks.length > 5 ? 
                                    `<div class="text-secondary">... è¿˜æœ‰ ${notification.deletedBookmarks.length - 5} ä¸ª</div>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateSummary(notifications) {
            const totalChecks = notifications.length;
            const totalDeleted = notifications.reduce((sum, n) => sum + (n.deleted || 0), 0);
            const lastCheck = notifications.length > 0 ? 
                new Date(notifications[0].checkedAt).toLocaleDateString() : '-';
            
            document.getElementById('totalChecks').textContent = totalChecks;
            document.getElementById('totalDeleted').textContent = totalDeleted;
            document.getElementById('lastCheckTime').textContent = lastCheck;
        }
    </script>
</body>
</html>
