<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè®¿é—®ä»¤ç‰Œç®¡ç† - ä¹¦ç­¾å¯¼èˆª</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/token-enhanced.css">
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€çš„å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ”‘</span>
                    <h1 class="logo-text">APIè®¿é—®ä»¤ç‰Œ</h1>
                </div>

                <!-- ç»Ÿä¸€çš„åŠŸèƒ½æŒ‰é’®ç»„ -->
                <div class="header-actions">
                    <!-- å·¥å…·èœå• -->
                    <div class="action-group tools-menu">
                        <button id="toolsMenuToggle" class="action-btn-icon menu-toggle" title="å·¥å…·èœå•">
                            <span class="btn-icon">ğŸ› ï¸</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="toolsDropdown" class="dropdown-menu">
                            <a href="/" class="dropdown-item">
                                <span class="item-icon">ğŸ </span>
                                <div class="item-content">
                                    <span class="item-text">é¦–é¡µ</span>
                                    <span class="item-desc">è¿”å›ä¹¦ç­¾é¦–é¡µ</span>
                                </div>
                            </a>
                            <a href="/link-checker.html" class="dropdown-item">
                                <span class="item-icon">ğŸ”—</span>
                                <div class="item-content">
                                    <span class="item-text">é“¾æ¥æ£€æŸ¥</span>
                                    <span class="item-desc">æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§</span>
                                </div>
                            </a>
                            <a href="/deleted-bookmarks.html" class="dropdown-item">
                                <span class="item-icon">ğŸ—‘ï¸</span>
                                <div class="item-content">
                                    <span class="item-text">åˆ é™¤è®°å½•</span>
                                    <span class="item-desc">æŸ¥çœ‹å’Œæ¢å¤åˆ é™¤çš„ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <a href="/notifications.html" class="dropdown-item">
                                <span class="item-icon">ğŸ””</span>
                                <div class="item-content">
                                    <span class="item-text">é€šçŸ¥ä¸­å¿ƒ</span>
                                    <span class="item-desc">æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥</span>
                                </div>
                            </a>
                            <a href="/import.html" class="dropdown-item">
                                <span class="item-icon">ğŸ“¥</span>
                                <div class="item-content">
                                    <span class="item-text">å¯¼å…¥ä¹¦ç­¾</span>
                                    <span class="item-desc">ä»æ–‡ä»¶å¯¼å…¥ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <div class="dropdown-divider"></div>
                            <button id="changePasswordBtn" class="dropdown-item">
                                <span class="item-icon">ğŸ”</span>
                                <div class="item-content">
                                    <span class="item-text">ä¿®æ”¹å¯†ç </span>
                                    <span class="item-desc">æ›´æ”¹ç®¡ç†å‘˜å¯†ç </span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="token-container">
            <!-- ç”Ÿæˆæ–°ä»¤ç‰Œ -->
            <div class="token-card">
                <div class="token-header">
                    <h2>ğŸ”‘ ç”Ÿæˆæ–°çš„APIè®¿é—®ä»¤ç‰Œ</h2>
                </div>
                
                <form id="tokenForm" class="token-form">
                    <div class="form-group">
                        <label class="form-label" for="tokenName">ä»¤ç‰Œåç§° *</label>
                        <input type="text" id="tokenName" class="form-input" 
                               placeholder="ä¾‹å¦‚: Chromeæ’ä»¶è®¿é—®" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="tokenDescription">æè¿°</label>
                        <input type="text" id="tokenDescription" class="form-input" 
                               placeholder="ä»¤ç‰Œç”¨é€”è¯´æ˜ï¼ˆå¯é€‰ï¼‰">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="tokenExpires">æœ‰æ•ˆæœŸ</label>
                        <select id="tokenExpires" class="form-select">
                            <option value="7">7å¤©</option>
                            <option value="30" selected>30å¤©</option>
                            <option value="90">90å¤©</option>
                            <option value="365">1å¹´</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">ğŸ”‘</span>
                        ç”Ÿæˆä»¤ç‰Œ
                    </button>
                </form>
                
                <!-- ç”Ÿæˆçš„ä»¤ç‰Œæ˜¾ç¤º -->
                <div id="tokenResult" class="hidden">
                    <h3>âœ… ä»¤ç‰Œç”ŸæˆæˆåŠŸ</h3>
                    <div class="warning-box">
                        <strong>âš ï¸ é‡è¦æé†’ï¼š</strong>
                        è¯·ç«‹å³å¤åˆ¶å¹¶ä¿å­˜æ­¤ä»¤ç‰Œï¼Œé¡µé¢åˆ·æ–°åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹ï¼
                    </div>
                    <div class="token-display">
                        <span id="generatedToken"></span>
                        <button class="copy-btn" onclick="copyToken()">å¤åˆ¶</button>
                    </div>
                    <div class="token-meta">
                        <p><strong>ä»¤ç‰Œåç§°ï¼š</strong><span id="resultName"></span></p>
                        <p><strong>è¿‡æœŸæ—¶é—´ï¼š</strong><span id="resultExpires"></span></p>
                    </div>
                </div>
            </div>

            <!-- ç°æœ‰ä»¤ç‰Œåˆ—è¡¨ -->
            <div class="token-card">
                <div class="token-header">
                    <h2>ğŸ“‹ ç°æœ‰ä»¤ç‰Œ</h2>
                    <button onclick="loadTokens()" class="btn btn-outline">
                        <span class="btn-icon">ğŸ”„</span>
                        åˆ·æ–°
                    </button>
                </div>
                
                <div id="tokenList" class="token-list">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div class="token-card">
                <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
                <div class="info-content">
                    <h3>Chromeæ’ä»¶é…ç½®</h3>
                    <ol>
                        <li>ç”ŸæˆAPIè®¿é—®ä»¤ç‰Œ</li>
                        <li>åœ¨Chromeæ’ä»¶ä¸­é…ç½®æœåŠ¡å™¨åœ°å€å’Œä»¤ç‰Œ</li>
                        <li>æµ‹è¯•è¿æ¥ç¡®ä¿é…ç½®æ­£ç¡®</li>
                        <li>å¼€å§‹åŒæ­¥ä¹¦ç­¾</li>
                    </ol>
                    
                    <h3>ä»¤ç‰Œç®¡ç†</h3>
                    <ul>
                        <li><strong>ç”Ÿæˆä»¤ç‰Œï¼š</strong>å¡«å†™ä»¤ç‰Œåç§°å’Œæœ‰æ•ˆæœŸï¼Œç‚¹å‡»ç”Ÿæˆ</li>
                        <li><strong>æŸ¥çœ‹ä»¤ç‰Œï¼š</strong>åœ¨ç°æœ‰ä»¤ç‰Œåˆ—è¡¨ä¸­æŸ¥çœ‹æ‰€æœ‰ä»¤ç‰ŒçŠ¶æ€</li>
                        <li><strong>åˆ é™¤ä»¤ç‰Œï¼š</strong>ç‚¹å‡»åˆ é™¤æŒ‰é’®å¯ç«‹å³æ’¤é”€ä»¤ç‰Œè®¿é—®æƒé™</li>
                        <li><strong>è¿‡æœŸå¤„ç†ï¼š</strong>è¿‡æœŸä»¤ç‰Œä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œå»ºè®®åŠæ—¶æ¸…ç†</li>
                    </ul>

                    <h3>APIä½¿ç”¨æ–¹å¼</h3>
                    <p>åœ¨HTTPè¯·æ±‚å¤´ä¸­æ·»åŠ ï¼š</p>
                    <div class="token-display">
                        X-API-Token: your-token-here
                    </div>

                    <h3>å®‰å…¨æé†’</h3>
                    <ul>
                        <li>ä»¤ç‰Œå…·æœ‰å®Œæ•´çš„APIè®¿é—®æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡</li>
                        <li>ä¸è¦åœ¨å…¬å¼€åœºæ‰€æˆ–ä¸å®‰å…¨çš„ç¯å¢ƒä¸­æš´éœ²ä»¤ç‰Œ</li>
                        <li>å®šæœŸæ£€æŸ¥å’Œæ¸…ç†ä¸éœ€è¦çš„ä»¤ç‰Œ</li>
                        <li>å¦‚å‘ç°ä»¤ç‰Œæ³„éœ²ï¼Œè¯·ç«‹å³åˆ é™¤å¹¶é‡æ–°ç”Ÿæˆ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="js/utils/api.js"></script>
    <script>
        // å·¥å…·èœå•åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const toolsMenuToggle = document.getElementById('toolsMenuToggle');
            const toolsDropdown = document.getElementById('toolsDropdown');

            if (toolsMenuToggle && toolsDropdown) {
                // åˆ‡æ¢ä¸‹æ‹‰èœå•
                toolsMenuToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toolsDropdown.classList.toggle('show');
                    toolsMenuToggle.classList.toggle('active');
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                document.addEventListener('click', (e) => {
                    if (!toolsMenuToggle.contains(e.target) && !toolsDropdown.contains(e.target)) {
                        toolsDropdown.classList.remove('show');
                        toolsMenuToggle.classList.remove('active');
                    }
                });

                // ä¿®æ”¹å¯†ç æŒ‰é’®äº‹ä»¶
                const changePasswordBtn = document.getElementById('changePasswordBtn');
                if (changePasswordBtn) {
                    changePasswordBtn.addEventListener('click', () => {
                        // é‡å®šå‘åˆ°é¦–é¡µå¹¶è§¦å‘å¯†ç ä¿®æ”¹æ¨¡æ€æ¡†
                        window.location.href = '/?action=change-password';
                    });
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å’ŒåŠ è½½ä»¤ç‰Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            await loadTokens();
        });

        // ç”Ÿæˆä»¤ç‰Œ
        document.getElementById('tokenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('tokenName').value;
            const description = document.getElementById('tokenDescription').value;
            const expiresIn = parseInt(document.getElementById('tokenExpires').value);
            
            try {
                const response = await API.post('/api/auth/token', {
                    name,
                    description,
                    expiresIn
                });
                
                if (response.success) {
                    // æ˜¾ç¤ºç”Ÿæˆçš„ä»¤ç‰Œ
                    document.getElementById('generatedToken').textContent = response.data.token;
                    document.getElementById('resultName').textContent = response.data.name;
                    document.getElementById('resultExpires').textContent = response.data.expiresAt;
                    document.getElementById('tokenResult').classList.remove('hidden');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('tokenForm').reset();
                    
                    // åˆ·æ–°ä»¤ç‰Œåˆ—è¡¨
                    await loadTokens();
                } else {
                    alert('ç”Ÿæˆä»¤ç‰Œå¤±è´¥: ' + response.error);
                }
            } catch (error) {
                alert('ç”Ÿæˆä»¤ç‰Œå¤±è´¥: ' + error.message);
            }
        });

        // åŠ è½½ä»¤ç‰Œåˆ—è¡¨
        async function loadTokens() {
            try {
                const response = await API.get('/api/auth/token');
                const tokenList = document.getElementById('tokenList');
                
                if (response.success && response.data.length > 0) {
                    tokenList.innerHTML = response.data.map(token => {
                        const isExpired = new Date(token.expires) <= new Date();
                        return `
                        <div class="token-item" data-token-id="${token.id}" data-token-name="${token.name.replace(/"/g, '&quot;')}">
                            <div class="token-info">
                                <h4>${token.name}</h4>
                                <div class="token-meta">
                                    <div>æè¿°: ${token.description || 'æ— '}</div>
                                    <div>åˆ›å»ºæ—¶é—´: ${new Date(token.created).toLocaleString()}</div>
                                    <div>è¿‡æœŸæ—¶é—´: ${new Date(token.expires).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="token-actions">
                                <span class="status-badge ${isExpired ? 'disconnected' : 'connected'}">
                                    ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ'}
                                </span>
                                <button class="delete-btn" data-action="delete" title="åˆ é™¤ä»¤ç‰Œ">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>
                        `;
                    }).join('');

                    // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨å¹¶æ·»åŠ æ–°çš„
                    tokenList.removeEventListener('click', handleTokenAction);
                    tokenList.addEventListener('click', handleTokenAction);
                } else {
                    tokenList.innerHTML = '<div class="empty-state">æš‚æ— APIä»¤ç‰Œ</div>';
                }
            } catch (error) {
                document.getElementById('tokenList').innerHTML = '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // å¤„ç†tokenæ“ä½œäº‹ä»¶
        function handleTokenAction(event) {
            const button = event.target.closest('.delete-btn');
            if (!button) return;

            const tokenItem = button.closest('.token-item');
            const tokenId = tokenItem.dataset.tokenId;
            const tokenName = tokenItem.dataset.tokenName;

            if (button.dataset.action === 'delete') {
                deleteToken(tokenId, tokenName);
            }
        }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(title, message, onConfirm) {
            const dialog = document.createElement('div');
            dialog.className = 'confirm-dialog';
            dialog.innerHTML = `
                <div class="confirm-content">
                    <div class="confirm-title">${title}</div>
                    <div class="confirm-message">${message}</div>
                    <div class="confirm-actions">
                        <button class="btn btn-secondary" id="cancelBtn">
                            å–æ¶ˆ
                        </button>
                        <button class="btn btn-primary" style="background: var(--error-color);" id="confirmBtn">
                            ç¡®è®¤åˆ é™¤
                        </button>
                    </div>
                </div>
            `;

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const cancelBtn = dialog.querySelector('#cancelBtn');
            const confirmBtn = dialog.querySelector('#confirmBtn');

            cancelBtn.addEventListener('click', () => {
                dialog.remove();
            });

            confirmBtn.addEventListener('click', () => {
                dialog.remove();
                onConfirm();
            });

            document.body.appendChild(dialog);
        }

        // åˆ é™¤ä»¤ç‰Œ
        function deleteToken(tokenId, tokenName) {
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            showConfirmDialog(
                'âš ï¸ åˆ é™¤APIä»¤ç‰Œ',
                `ç¡®å®šè¦åˆ é™¤ä»¤ç‰Œ "<strong>${tokenName}</strong>" å—ï¼Ÿ<br><br>åˆ é™¤åè¯¥ä»¤ç‰Œå°†ç«‹å³å¤±æ•ˆï¼Œæ— æ³•æ¢å¤ã€‚`,
                () => performDeleteToken(tokenId, tokenName)
            );
        }

        // æ‰§è¡Œåˆ é™¤æ“ä½œ
        async function performDeleteToken(tokenId, tokenName) {
            // æ‰¾åˆ°å¯¹åº”çš„åˆ é™¤æŒ‰é’®å¹¶ç¦ç”¨
            const tokenItem = document.querySelector(`[data-token-id="${tokenId}"]`);
            const deleteBtn = tokenItem?.querySelector('.delete-btn');

            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'åˆ é™¤ä¸­...';
            }

            try {
                const response = await API.post('/api/auth/token', {
                    action: 'delete',
                    tokenId: tokenId
                });

                if (response.success) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`ä»¤ç‰Œ "${tokenName}" å·²æˆåŠŸåˆ é™¤`, 'success');

                    // åˆ·æ–°ä»¤ç‰Œåˆ—è¡¨
                    await loadTokens();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'), 'error');

                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                    }
                }
            } catch (error) {
                let errorMessage = 'åˆ é™¤å¤±è´¥';

                if (error.message.includes('405')) {
                    errorMessage = 'æœåŠ¡å™¨ä¸æ”¯æŒæ­¤æ“ä½œï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                } else if (error.message.includes('401')) {
                    errorMessage = 'æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•';
                } else if (error.message.includes('404')) {
                    errorMessage = 'ä»¤ç‰Œä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤';
                } else if (error.message.includes('400')) {
                    errorMessage = 'è¯·æ±‚å‚æ•°é”™è¯¯';
                } else {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•';
                }

                showMessage(errorMessage, 'error');

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                }
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            message.textContent = text;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#message-styles')) {
                const style = document.createElement('style');
                style.id = 'message-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(message);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                message.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => message.remove(), 300);
            }, 3000);
        }

        // å¤åˆ¶ä»¤ç‰Œ
        function copyToken() {
            const token = document.getElementById('generatedToken').textContent;
            navigator.clipboard.writeText(token).then(() => {
                const btn = document.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = 'å·²å¤åˆ¶';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }
    </script>
</body>
</html>
