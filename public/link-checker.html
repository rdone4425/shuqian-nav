<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¾æ¥æ£€æŸ¥å™¨ - ä¹¦ç­¾å¯¼èˆª</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/link-checker-enhanced.css">
    <style>
        /* ä»…ä¿ç•™å¿…è¦çš„å·¥å…·æ ·å¼ */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç»Ÿä¸€çš„å¤´éƒ¨å¯¼èˆª -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ”—</span>
                    <h1 class="logo-text">é“¾æ¥æ£€æŸ¥å™¨</h1>
                </div>

                <!-- ç»Ÿä¸€çš„åŠŸèƒ½æŒ‰é’®ç»„ -->
                <div class="header-actions">
                    <!-- å·¥å…·èœå• -->
                    <div class="action-group tools-menu">
                        <button id="toolsMenuToggle" class="action-btn-icon menu-toggle" title="å·¥å…·èœå•">
                            <span class="btn-icon">ğŸ› ï¸</span>
                            <span class="dropdown-arrow">â–¼</span>
                        </button>
                        <div id="toolsDropdown" class="dropdown-menu">
                            <a href="/" class="dropdown-item">
                                <span class="item-icon">ğŸ </span>
                                <div class="item-content">
                                    <span class="item-text">é¦–é¡µ</span>
                                    <span class="item-desc">è¿”å›ä¹¦ç­¾é¦–é¡µ</span>
                                </div>
                            </a>
                            <a href="/token.html" class="dropdown-item">
                                <span class="item-icon">ğŸ”‘</span>
                                <div class="item-content">
                                    <span class="item-text">APIä»¤ç‰Œ</span>
                                    <span class="item-desc">ç®¡ç†è®¿é—®ä»¤ç‰Œ</span>
                                </div>
                            </a>
                            <a href="/link-checker.html" class="dropdown-item">
                                <span class="item-icon">ğŸ”—</span>
                                <div class="item-content">
                                    <span class="item-text">é“¾æ¥æ£€æŸ¥</span>
                                    <span class="item-desc">æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§</span>
                                </div>
                            </a>
                            <a href="/deleted-bookmarks.html" class="dropdown-item">
                                <span class="item-icon">ğŸ—‘ï¸</span>
                                <div class="item-content">
                                    <span class="item-text">åˆ é™¤è®°å½•</span>
                                    <span class="item-desc">æŸ¥çœ‹å’Œæ¢å¤åˆ é™¤çš„ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <a href="/notifications.html" class="dropdown-item">
                                <span class="item-icon">ğŸ””</span>
                                <div class="item-content">
                                    <span class="item-text">é€šçŸ¥ä¸­å¿ƒ</span>
                                    <span class="item-desc">æŸ¥çœ‹ç³»ç»Ÿé€šçŸ¥</span>
                                </div>
                            </a>
                            <a href="/import.html" class="dropdown-item">
                                <span class="item-icon">ğŸ“¥</span>
                                <div class="item-content">
                                    <span class="item-text">å¯¼å…¥ä¹¦ç­¾</span>
                                    <span class="item-desc">ä»æ–‡ä»¶å¯¼å…¥ä¹¦ç­¾</span>
                                </div>
                            </a>
                            <div class="dropdown-divider"></div>
                            <button id="changePasswordBtn" class="dropdown-item">
                                <span class="item-icon">ğŸ”</span>
                                <div class="item-content">
                                    <span class="item-text">ä¿®æ”¹å¯†ç </span>
                                    <span class="item-desc">æ›´æ”¹ç®¡ç†å‘˜å¯†ç </span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="checker-container">
            <!-- æ£€æŸ¥æ§åˆ¶é¢æ¿ -->
            <div class="controls-section">
                <div class="checker-header">
                    <h2>ğŸ” é“¾æ¥å¯è®¿é—®æ€§æ£€æŸ¥</h2>
                </div>
                <div class="safety-notice">
                    ğŸ›¡ï¸ å®‰å…¨æ¨¡å¼ï¼šåªæ£€æŸ¥ä¸åˆ é™¤ï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤åˆ é™¤
                </div>

                <div class="controls-row">
                    <div class="control-group">
                        <input type="checkbox" id="smartCheck" checked />
                        <label for="smartCheck">æ™ºèƒ½æ£€æŸ¥ï¼ˆæé«˜å‡†ç¡®æ€§ï¼‰</label>
                    </div>
                    <div class="control-group">
                        <label for="retryCount">é‡è¯•æ¬¡æ•°:</label>
                        <select id="retryCount">
                            <option value="1">1æ¬¡</option>
                            <option value="2" selected>2æ¬¡</option>
                            <option value="3">3æ¬¡</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="checkDelay">æ£€æŸ¥é—´éš”:</label>
                        <select id="checkDelay">
                            <option value="200">0.2ç§’</option>
                            <option value="500" selected>0.5ç§’</option>
                            <option value="1000">1ç§’</option>
                            <option value="2000">2ç§’</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <button id="startCheck" class="btn btn-primary">
                        ğŸš€ å¼€å§‹æ£€æŸ¥
                    </button>
                    <button id="stopCheck" class="btn btn-secondary hidden">
                        â¹ï¸ åœæ­¢æ£€æŸ¥
                    </button>
                    <button id="viewHistory" class="btn btn-secondary">
                        ğŸ“‹ æŸ¥çœ‹å†å²
                    </button>
                    <button id="batchDelete" class="btn btn-secondary hidden">
                        ğŸ—‘ï¸ åˆ é™¤æ‰€æœ‰æ— æ•ˆé“¾æ¥
                    </button>
                </div>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progressSection" class="progress-section">
                <div class="progress-header">
                    <span id="progressText" class="progress-text">å‡†å¤‡æ£€æŸ¥...</span>
                    <span id="progressPercent" class="progress-percent">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item" data-filter="all">
                        <span class="stat-value" id="totalBookmarks">0</span>
                        <span class="stat-label">æ€»è®¡</span>
                    </div>
                    <div class="stat-item" data-filter="checked">
                        <span class="stat-value" id="checkedCount">0</span>
                        <span class="stat-label">å·²æ£€æŸ¥</span>
                    </div>
                    <div class="stat-item" data-filter="accessible">
                        <span class="stat-value" id="accessibleCount">0</span>
                        <span class="stat-label">å¯è®¿é—®</span>
                    </div>
                    <div class="stat-item" data-filter="inaccessible">
                        <span class="stat-value" id="inaccessibleCount">0</span>
                        <span class="stat-label">ä¸å¯è®¿é—®</span>
                    </div>
                    <div class="stat-item" data-filter="deleted">
                        <span class="stat-value" id="deletedCount">0</span>
                        <span class="stat-label">å·²åˆ é™¤</span>
                    </div>
                    <div class="stat-item" data-filter="kept">
                        <span class="stat-value" id="keptCount">0</span>
                        <span class="stat-label">å·²ä¿ç•™</span>
                    </div>
                </div>
            </div>

            <!-- æ£€æŸ¥è¯´æ˜ -->
            <div class="details-section">
                <div class="details-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
                    <h3 style="margin: 0; font-size: var(--font-xl); font-weight: 700; color: var(--text-primary);">ğŸ” æ£€æŸ¥é€»è¾‘è¯´æ˜</h3>
                    <button id="toggleExplanation" class="btn btn-secondary">
                        ğŸ“– <span id="explanationToggleText">æ˜¾ç¤ºè¯¦æƒ…</span>
                    </button>
                </div>

                <div id="explanationContent" class="details-content hidden">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--spacing-lg);">
                        <div>
                            <h4>âœ… è®¤ä¸ºå¯è®¿é—®çš„æƒ…å†µ</h4>
                            <ul>
                                <li>HTTP 2xx çŠ¶æ€ç ï¼ˆæˆåŠŸï¼‰</li>
                                <li>HTTP 3xx çŠ¶æ€ç ï¼ˆé‡å®šå‘ï¼‰</li>
                                <li>HTTP 401ï¼ˆéœ€è¦ç™»å½•ï¼Œä½†ç½‘ç«™å­˜åœ¨ï¼‰</li>
                                <li>Cloudflare 403/503ï¼ˆé˜²æŠ¤æœºåˆ¶ï¼Œç½‘ç«™æ­£å¸¸ï¼‰</li>
                            </ul>
                        </div>

                        <div>
                            <h4>âš ï¸ å»ºè®®ä¿ç•™çš„æƒ…å†µ</h4>
                            <ul>
                                <li>Cloudflareé˜²æŠ¤é¡µé¢</li>
                                <li>è¯·æ±‚è¶…æ—¶ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰</li>
                                <li>5xxæœåŠ¡å™¨é”™è¯¯ï¼ˆå¯èƒ½æ˜¯ä¸´æ—¶ç»´æŠ¤ï¼‰</li>
                                <li>429é™æµï¼ˆè¯·æ±‚è¿‡äºé¢‘ç¹ï¼‰</li>
                                <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                            </ul>
                        </div>

                        <div>
                            <h4>ğŸ—‘ï¸ å»ºè®®åˆ é™¤çš„æƒ…å†µ</h4>
                            <ul>
                                <li>404 é¡µé¢ä¸å­˜åœ¨</li>
                                <li>410 é¡µé¢å·²æ°¸ä¹…åˆ é™¤</li>
                                <li>åŸŸåä¸å­˜åœ¨ï¼ˆENOTFOUNDï¼‰</li>
                                <li>SSLè¯ä¹¦ä¸¥é‡é—®é¢˜</li>
                            </ul>
                        </div>

                        <div>
                            <h4>ğŸ›¡ï¸ é˜²è¯¯æ€æœºåˆ¶</h4>
                            <ul>
                                <li>ä½¿ç”¨çœŸå®æµè§ˆå™¨User-Agent</li>
                                <li>å…ˆå°è¯•HEADè¯·æ±‚ï¼Œå¤±è´¥åå°è¯•GET</li>
                                <li>ç‰¹æ®Šå¤„ç†Cloudflareç­‰CDNæœåŠ¡</li>
                                <li>å¤šæ¬¡é‡è¯•å‡å°‘ç½‘ç»œæ³¢åŠ¨å½±å“</li>
                                <li>é»˜è®¤å€¾å‘äºä¿ç•™ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¹¦ç­¾åˆ—è¡¨ -->
            <div id="bookmarksCard" class="bookmarks-section">
                <div class="bookmarks-header">
                    <h2>ğŸ“š ä¹¦ç­¾åˆ—è¡¨</h2>
                    <div style="display: flex; align-items: center; gap: var(--spacing-md);">
                        <span id="filterStatus" class="bookmarks-stats"></span>
                        <button id="loadBookmarks" class="btn btn-secondary">
                            ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <div id="bookmarksList">
                    <div class="loading">åŠ è½½ä¹¦ç­¾åˆ—è¡¨...</div>
                </div>
            </div>

                <!-- åˆ é™¤çš„ä¹¦ç­¾åˆ—è¡¨ -->
                <div id="deletedSection" class="hidden">
                    <h3>ğŸ—‘ï¸ å·²åˆ é™¤çš„ä¹¦ç­¾</h3>
                    <div id="deletedList"></div>
                </div>

                <!-- æ— æ•ˆé“¾æ¥åˆ—è¡¨ -->
                <div id="inaccessibleSection" class="hidden">
                    <h3>âš ï¸ æ— æ³•è®¿é—®çš„é“¾æ¥</h3>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>æ ‡é¢˜</th>
                                <th>URL</th>
                                <th>çŠ¶æ€</th>
                                <th>é”™è¯¯ä¿¡æ¯</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="inaccessibleList">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- æ£€æŸ¥å†å² -->
            <div id="historyCard" class="checker-card hidden">
                <div class="checker-header">
                    <h2>ğŸ“‹ æ£€æŸ¥å†å²</h2>
                    <button onclick="toggleHistory()" class="btn btn-outline">å…³é—­</button>
                </div>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script src="js/utils/api.js"></script>
    <script>
        // å·¥å…·èœå•åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const toolsMenuToggle = document.getElementById('toolsMenuToggle');
            const toolsDropdown = document.getElementById('toolsDropdown');

            if (toolsMenuToggle && toolsDropdown) {
                // åˆ‡æ¢ä¸‹æ‹‰èœå•
                toolsMenuToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toolsDropdown.classList.toggle('show');
                    toolsMenuToggle.classList.toggle('active');
                });

                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                document.addEventListener('click', (e) => {
                    if (!toolsMenuToggle.contains(e.target) && !toolsDropdown.contains(e.target)) {
                        toolsDropdown.classList.remove('show');
                        toolsMenuToggle.classList.remove('active');
                    }
                });

                // ä¿®æ”¹å¯†ç æŒ‰é’®äº‹ä»¶
                const changePasswordBtn = document.getElementById('changePasswordBtn');
                if (changePasswordBtn) {
                    changePasswordBtn.addEventListener('click', () => {
                        // é‡å®šå‘åˆ°é¦–é¡µå¹¶è§¦å‘å¯†ç ä¿®æ”¹æ¨¡æ€æ¡†
                        window.location.href = '/?action=change-password';
                    });
                }
            }
        });

        let bookmarks = [];
        let isChecking = false;
        let checkingIndex = 0;
        let currentFilter = 'all';
        let stats = {
            total: 0,
            checked: 0,
            accessible: 0,
            inaccessible: 0,
            deleted: 0,
            kept: 0
        };

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½ä¹¦ç­¾
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            // å…ˆæ‰§è¡Œæ•°æ®åº“è¿ç§»
            await performMigration();
            // ç„¶ååŠ è½½ä¹¦ç­¾
            await loadBookmarks();
        });

        // æ‰§è¡Œæ•°æ®åº“è¿ç§»
        async function performMigration() {
            try {
                console.log('æ£€æŸ¥æ•°æ®åº“è¿ç§»...');
                const response = await API.post('/api/system/migrate', {});
                if (response.success) {
                    console.log('æ•°æ®åº“è¿ç§»å®Œæˆ:', response.message);
                } else {
                    console.warn('æ•°æ®åº“è¿ç§»å¤±è´¥:', response.error);
                }
            } catch (error) {
                console.warn('æ•°æ®åº“è¿ç§»æ£€æŸ¥å¤±è´¥:', error.message);
                // è¿ç§»å¤±è´¥ä¸å½±å“é¡µé¢æ­£å¸¸ä½¿ç”¨
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('startCheck').addEventListener('click', startLinkCheck);
        document.getElementById('stopCheck').addEventListener('click', stopLinkCheck);
        document.getElementById('loadBookmarks').addEventListener('click', loadBookmarks);
        document.getElementById('viewHistory').addEventListener('click', async () => {
            await loadHistory();
            toggleHistory();
        });
        document.getElementById('batchDelete').addEventListener('click', batchDeleteInaccessible);
        document.getElementById('toggleExplanation').addEventListener('click', toggleExplanation);

        // ç»‘å®šç»Ÿè®¡é¡¹ç­›é€‰äº‹ä»¶
        document.querySelectorAll('.stat-item').forEach(item => {
            item.addEventListener('click', function() {
                const filter = this.dataset.filter;
                currentFilter = filter;
                filterBookmarksDisplay(filter);

                // æ›´æ–°æ´»è·ƒçŠ¶æ€
                document.querySelectorAll('.stat-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // ç»‘å®šç­›é€‰æŒ‰é’®å’Œåˆ é™¤æŒ‰é’®äº‹ä»¶
        document.addEventListener('click', (e) => {
            // ç­›é€‰æŒ‰é’®
            if (e.target.classList.contains('filter-btn') || e.target.closest('.filter-btn')) {
                const filterBtn = e.target.classList.contains('filter-btn') ? e.target : e.target.closest('.filter-btn');
                const filter = filterBtn.dataset.filter;
                setFilter(filter);
            }

            // åˆ é™¤æŒ‰é’®
            if (e.target.classList.contains('delete-single-btn')) {
                const bookmarkId = e.target.dataset.bookmarkId;
                if (bookmarkId) {
                    deleteBookmark(parseInt(bookmarkId));
                }
            }

            // ä¿ç•™æŒ‰é’®
            if (e.target.classList.contains('keep-btn')) {
                const bookmarkId = e.target.dataset.bookmarkId;
                if (bookmarkId) {
                    keepBookmark(parseInt(bookmarkId));
                }
            }

            // å–æ¶ˆä¿ç•™æŒ‰é’®
            if (e.target.classList.contains('unkeep-btn')) {
                const bookmarkId = e.target.dataset.bookmarkId;
                if (bookmarkId) {
                    unkeepBookmark(parseInt(bookmarkId));
                }
            }
        });

        // åŠ è½½ä¹¦ç­¾åˆ—è¡¨
        async function loadBookmarks() {
            try {
                const response = await API.get('/api/system/check-links-stream');
                if (response.success && response.data) {
                    const newBookmarks = response.data;

                    // ç¡®ä¿ newBookmarks æ˜¯æ•°ç»„
                    if (!Array.isArray(newBookmarks)) {
                        throw new Error('æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                    }

                    // å¦‚æœå·²æœ‰ä¹¦ç­¾æ•°æ®ï¼Œä¿ç•™æ£€æŸ¥çŠ¶æ€
                    if (bookmarks && bookmarks.length > 0) {
                        const checkedBookmarksMap = new Map();
                        bookmarks.forEach(bookmark => {
                            if (bookmark.checked) {
                                checkedBookmarksMap.set(bookmark.id, {
                                    checked: bookmark.checked,
                                    checkedTime: bookmark.checkedTime,
                                    accessible: bookmark.accessible,
                                    status: bookmark.status,
                                    statusCode: bookmark.statusCode,
                                    statusText: bookmark.statusText,
                                    error: bookmark.error,
                                    keepStatus: bookmark.keepStatus,
                                    deleted: bookmark.deleted
                                });
                            }
                        });

                        newBookmarks.forEach(bookmark => {
                            const checkedData = checkedBookmarksMap.get(bookmark.id);
                            if (checkedData) {
                                Object.assign(bookmark, checkedData);
                            }
                        });
                    }

                    bookmarks = newBookmarks;
                    stats.total = bookmarks.length;
                    recalculateStats();
                    displayBookmarks();
                    updateStats();
                } else {
                    throw new Error(response.error || 'æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                }
            } catch (error) {
                console.error('åŠ è½½ä¹¦ç­¾å¤±è´¥:', error);
                document.getElementById('bookmarksList').innerHTML =
                    '<div class="error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
                // ç¡®ä¿ bookmarks ä»ç„¶æ˜¯æ•°ç»„
                if (!Array.isArray(bookmarks)) {
                    bookmarks = [];
                }
            }
        }

        // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
        function recalculateStats() {
            stats.checked = 0;
            stats.accessible = 0;
            stats.inaccessible = 0;
            stats.deleted = 0;

            bookmarks.forEach(bookmark => {
                if (bookmark.checked) {
                    stats.checked++;
                    if (bookmark.deleted) {
                        stats.deleted++;
                    } else if (bookmark.accessible) {
                        stats.accessible++;
                    } else {
                        stats.inaccessible++;
                    }
                }
            });
        }

        // è®¾ç½®ç­›é€‰å™¨
        function setFilter(filter) {
            currentFilter = filter;

            // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

            // é‡æ–°æ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨
            displayBookmarks();
        }

        // ç­›é€‰ä¹¦ç­¾
        function filterBookmarks(bookmarks) {
            if (currentFilter === 'all') {
                return bookmarks;
            }

            return bookmarks.filter(bookmark => {
                switch (currentFilter) {
                    case 'checked':
                        return bookmark.checked === true;
                    case 'accessible':
                        return bookmark.status === 'accessible';
                    case 'inaccessible':
                        return bookmark.status === 'inaccessible';
                    case 'deleted':
                        return bookmark.status === 'deleted';
                    case 'kept':
                        return bookmark.keepStatus === 'keep';
                    default:
                        return true;
                }
            });
        }

        // ä¸ºæ˜¾ç¤ºæ’åºä¹¦ç­¾ï¼šæ£€æŸ¥æ—¶åªæ˜¾ç¤ºå·²æ£€æŸ¥çš„ï¼Œæœªæ£€æŸ¥æ—¶æ˜¾ç¤ºå…¨éƒ¨
        function sortBookmarksForDisplay(bookmarks) {
            // å¦‚æœæ­£åœ¨æ£€æŸ¥ï¼Œåªæ˜¾ç¤ºå·²æ£€æŸ¥çš„ä¹¦ç­¾å’Œæ­£åœ¨æ£€æŸ¥çš„ä¹¦ç­¾
            let filteredBookmarks = bookmarks;
            if (isChecking) {
                filteredBookmarks = bookmarks.filter(bookmark =>
                    bookmark.checked || bookmark.status === 'checking'
                );
            }

            return filteredBookmarks.sort((a, b) => {
                // å¦‚æœä¸åœ¨æ£€æŸ¥ä¸­ï¼ŒæŒ‰åŸæ¥çš„é€»è¾‘ï¼šæœªæ£€æŸ¥çš„åœ¨å‰
                if (!isChecking) {
                    if (a.checked !== b.checked) {
                        return a.checked ? 1 : -1; // false (æœªæ£€æŸ¥) åœ¨å‰ï¼Œtrue (å·²æ£€æŸ¥) åœ¨å
                    }

                    // å¦‚æœéƒ½æ˜¯æœªæ£€æŸ¥çš„ï¼ŒæŒ‰åŸå§‹é¡ºåºï¼ˆIDï¼‰æ’åº
                    if (!a.checked && !b.checked) {
                        return a.id - b.id;
                    }

                    // å¦‚æœéƒ½æ˜¯å·²æ£€æŸ¥çš„ï¼ŒæŒ‰çŠ¶æ€ä¼˜å…ˆçº§æ’åº
                    if (a.checked && b.checked) {
                        const statusPriority = {
                            'accessible': 1,    // å¯è®¿é—®çš„
                            'inaccessible': 2,  // ä¸å¯è®¿é—®çš„
                            'deleted': 3        // å·²åˆ é™¤çš„åœ¨æœ€å
                        };

                        const aPriority = statusPriority[a.status] || 999;
                        const bPriority = statusPriority[b.status] || 999;

                        if (aPriority !== bPriority) {
                            return aPriority - bPriority;
                        }

                        // åŒçŠ¶æ€æŒ‰IDæ’åº
                        return a.id - b.id;
                    }
                } else {
                    // æ£€æŸ¥ä¸­çš„æ’åºé€»è¾‘ï¼šæ­£åœ¨æ£€æŸ¥çš„åœ¨æœ€å‰ï¼Œç„¶åæŒ‰æ£€æŸ¥å®Œæˆçš„æ—¶é—´å€’åº
                    if (a.status === 'checking' && b.status !== 'checking') {
                        return -1; // æ­£åœ¨æ£€æŸ¥çš„åœ¨æœ€å‰
                    }
                    if (b.status === 'checking' && a.status !== 'checking') {
                        return 1;
                    }

                    // å¦‚æœéƒ½æ˜¯å·²æ£€æŸ¥å®Œæˆçš„ï¼ŒæŒ‰æ£€æŸ¥å®Œæˆæ—¶é—´å€’åºï¼ˆæœ€æ–°æ£€æŸ¥çš„åœ¨ä¸Šé¢ï¼‰
                    if (a.checked && b.checked && a.status !== 'checking' && b.status !== 'checking') {
                        // ä½¿ç”¨æ£€æŸ¥å®Œæˆæ—¶é—´æˆ³ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨IDå€’åº
                        const aTime = a.checkedTime || (999999 - a.id);
                        const bTime = b.checkedTime || (999999 - b.id);
                        return bTime - aTime; // å€’åºï¼šæœ€æ–°çš„åœ¨ä¸Šé¢
                    }
                }

                return 0;
            });
        }

        // æ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨
        function displayBookmarks() {
            const bookmarksList = document.getElementById('bookmarksList');
            const filterStatus = document.getElementById('filterStatus');

            // ç¡®ä¿ bookmarks æ˜¯æ•°ç»„
            if (!Array.isArray(bookmarks) || bookmarks.length === 0) {
                bookmarksList.innerHTML = '<div class="empty-state">æš‚æ— ä¹¦ç­¾</div>';
                if (filterStatus) filterStatus.textContent = '';
                return;
            }

            const filteredBookmarks = filterBookmarks(bookmarks);
            updateFilterStatus(filteredBookmarks.length);

            if (filteredBookmarks.length === 0) {
                bookmarksList.innerHTML = `<div class="empty-state">æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„ä¹¦ç­¾</div>`;
                return;
            }

            const sortedBookmarks = sortBookmarksForDisplay(filteredBookmarks);

            bookmarksList.innerHTML = sortedBookmarks.map((bookmark, index) => {
                const originalIndex = bookmarks.findIndex(b => b.id === bookmark.id);
                const displayIndex = index + 1;

                return `
                <div class="bookmark-item ${bookmark.status || ''}" id="bookmark-${bookmark.id}" data-index="${originalIndex}">
                    <div class="bookmark-status status-${bookmark.status || 'pending'}" id="status-${bookmark.id}">
                        ${getStatusIcon(bookmark, displayIndex)}
                    </div>
                    <div class="bookmark-info">
                        <div class="bookmark-title">
                            ${bookmark.title || bookmark.name || 'æ— æ ‡é¢˜'}
                        </div>
                        <div class="bookmark-url">
                            <a href="${bookmark.url || '#'}" target="_blank" rel="noopener noreferrer" title="ç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€">
                                ${bookmark.url || 'æ— URL'}
                            </a>
                        </div>
                    </div>
                    <div class="bookmark-meta">
                        <div class="bookmark-category" style="background-color: ${bookmark.categoryColor || '#6B7280'}">
                            ${bookmark.category || 'æœªåˆ†ç±»'}
                        </div>
                        <div class="bookmark-result" id="result-${bookmark.id}">
                            ${getResultText(bookmark)}
                        </div>
                    </div>
                    <div class="bookmark-actions-container" id="actions-${bookmark.id}">
                        ${getBookmarkActions(bookmark)}
                    </div>
                </div>
                `;
            }).join('');

            // ç¡®ä¿æ“ä½œæŒ‰é’®å¯¹ä¸å¯è®¿é—®çš„ä¹¦ç­¾å¯è§
            setTimeout(() => {
                ensureActionButtonsVisible();
            }, 100);
        }

        // è·å–ç»“æœæ–‡æœ¬
        function getResultText(bookmark) {
            if (!bookmark.checked) {
                return 'ç­‰å¾…æ£€æŸ¥';
            }

            switch (bookmark.status) {
                case 'checking':
                    return 'æ£€æŸ¥ä¸­...';
                case 'accessible':
                    return `${bookmark.statusCode} ${bookmark.statusText}`;
                case 'inaccessible':
                    return bookmark.error || `${bookmark.statusCode} ${bookmark.statusText}`;
                case 'deleted':
                    return 'å·²åˆ é™¤';
                default:
                    return 'ç­‰å¾…æ£€æŸ¥';
            }
        }

        // è·å–çŠ¶æ€å›¾æ ‡
        function getStatusIcon(bookmark, displayIndex) {
            switch (bookmark.status) {
                case 'pending':
                    return displayIndex; // æ˜¾ç¤ºåºå·
                case 'checking':
                    return 'â³';
                case 'accessible':
                    return 'âœ“';
                case 'inaccessible':
                    return 'âœ—';
                case 'deleted':
                    return 'ğŸ—‘ï¸';
                default:
                    return displayIndex; // é»˜è®¤æ˜¾ç¤ºåºå·
            }
        }

        // ç¡®ä¿æ“ä½œæŒ‰é’®å¯¹ä¸å¯è®¿é—®çš„ä¹¦ç­¾å¯è§
        function ensureActionButtonsVisible() {
            bookmarks.forEach(bookmark => {
                if ((bookmark.status === 'inaccessible' || (bookmark.checked && !bookmark.accessible)) && !bookmark.deleted) {
                    const actionsContainer = document.getElementById(`actions-${bookmark.id}`);
                    if (actionsContainer && (!actionsContainer.innerHTML.trim() || !actionsContainer.querySelector('.bookmark-actions'))) {
                        const actionsHtml = `
                            <div class="bookmark-actions">
                                <button class="keep-btn" data-bookmark-id="${bookmark.id}" title="æ ‡è®°ä¸ºä¿ç•™ï¼ˆä¸å†å»ºè®®åˆ é™¤ï¼‰">
                                    ğŸ“Œ ä¿ç•™
                                </button>
                                <button class="delete-single-btn" data-bookmark-id="${bookmark.id}" title="åˆ é™¤æ­¤ä¹¦ç­¾">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        `;
                        actionsContainer.innerHTML = actionsHtml;
                    }
                }
            });
        }

        // æ‰‹åŠ¨è§¦å‘æŒ‰é’®æ˜¾ç¤ºï¼ˆç”¨äºæµ‹è¯•ï¼‰
        window.forceShowButtons = function() {
            console.log('æ‰‹åŠ¨è§¦å‘æŒ‰é’®æ˜¾ç¤º...');
            ensureActionButtonsVisible();
        };

        // è·å–ä¹¦ç­¾æ“ä½œæŒ‰é’®
        function getBookmarkActions(bookmark) {
            // å¦‚æœå·²åˆ é™¤ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ“ä½œ
            if (bookmark.deleted || bookmark.status === 'deleted') {
                return '';
            }

            // å¦‚æœå·²æ ‡è®°ä¸ºä¿ç•™
            if (bookmark.keepStatus === 'keep') {
                return `<div class="bookmark-actions">
                    <span class="keep-status">ğŸ“Œ å·²ä¿ç•™</span>
                    <button class="unkeep-btn" data-bookmark-id="${bookmark.id}" title="å–æ¶ˆä¿ç•™æ ‡è®°">
                        âŒ å–æ¶ˆä¿ç•™
                    </button>
                    ${bookmark.status === 'inaccessible' ?
                        `<button class="delete-single-btn" data-bookmark-id="${bookmark.id}" title="åˆ é™¤æ­¤ä¹¦ç­¾">
                            ğŸ—‘ï¸ åˆ é™¤
                        </button>` : ''
                    }
                </div>`;
            }

            // å¦‚æœæ˜¯ä¸å¯è®¿é—®çš„ä¹¦ç­¾ - å¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’®
            if (bookmark.status === 'inaccessible' || (bookmark.checked && !bookmark.accessible)) {
                return `<div class="bookmark-actions">
                    <button class="keep-btn" data-bookmark-id="${bookmark.id}" title="æ ‡è®°ä¸ºä¿ç•™ï¼ˆä¸å†å»ºè®®åˆ é™¤ï¼‰">
                        ğŸ“Œ ä¿ç•™
                    </button>
                    <button class="delete-single-btn" data-bookmark-id="${bookmark.id}" title="åˆ é™¤æ­¤ä¹¦ç­¾">
                        ğŸ—‘ï¸ åˆ é™¤
                    </button>
                </div>`;
            }

            // å…¶ä»–æƒ…å†µä¸æ˜¾ç¤ºæ“ä½œæŒ‰é’®
            return '';
        }

        // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
        function updateFilterStatus(filteredCount) {
            const filterStatus = document.getElementById('filterStatus');

            if (isChecking) {
                // æ£€æŸ¥æ—¶æ˜¾ç¤ºç‰¹æ®Šä¿¡æ¯
                filterStatus.textContent = `æ£€æŸ¥ä¸­ï¼šæ˜¾ç¤ºå·²æ£€æŸ¥çš„ä¹¦ç­¾ (${filteredCount} ä¸ª)`;
            } else if (currentFilter === 'all') {
                filterStatus.textContent = `æ˜¾ç¤ºå…¨éƒ¨ ${filteredCount} ä¸ªä¹¦ç­¾`;
            } else {
                const filterNames = {
                    'checked': 'å·²æ£€æŸ¥',
                    'accessible': 'å¯è®¿é—®',
                    'inaccessible': 'ä¸å¯è®¿é—®',
                    'deleted': 'å·²åˆ é™¤',
                    'kept': 'å·²ä¿ç•™'
                };
                filterStatus.textContent = `ç­›é€‰: ${filterNames[currentFilter]} (${filteredCount}/${bookmarks.length})`;
            }
        }

        // å¼€å§‹æ£€æŸ¥
        async function startLinkCheck() {
            if (isChecking) return;

            const smartCheck = document.getElementById('smartCheck').checked;
            const retryCount = parseInt(document.getElementById('retryCount').value);
            const checkDelay = parseInt(document.getElementById('checkDelay').value);

            if (bookmarks.length === 0) {
                alert('æ²¡æœ‰ä¹¦ç­¾éœ€è¦æ£€æŸ¥');
                return;
            }

            isChecking = true;
            checkingIndex = 0;
            stats = { total: bookmarks.length, checked: 0, accessible: 0, inaccessible: 0, deleted: 0 };

            // æ›´æ–°UIçŠ¶æ€
            document.getElementById('startCheck').classList.add('hidden');
            document.getElementById('stopCheck').classList.remove('hidden');
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('batchDelete').classList.add('hidden'); // éšè—æ‰¹é‡åˆ é™¤æŒ‰é’®

            // é‡ç½®æ‰€æœ‰ä¹¦ç­¾çŠ¶æ€
            bookmarks.forEach(bookmark => {
                bookmark.status = 'pending';
                bookmark.checked = false;
                bookmark.retryCount = 0;
                bookmark.deleted = false; // é‡ç½®åˆ é™¤çŠ¶æ€
                updateBookmarkDisplay(bookmark);
            });

            // å¼€å§‹æ£€æŸ¥æ—¶é‡æ–°æ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºå·²æ£€æŸ¥çš„ï¼‰
            displayBookmarks();

            // å¼€å§‹é€ä¸ªæ£€æŸ¥
            await checkNextBookmark(smartCheck, retryCount, checkDelay);
        }

        // æ£€æŸ¥ä¸‹ä¸€ä¸ªä¹¦ç­¾
        async function checkNextBookmark(smartCheck, retryCount, checkDelay) {
            if (!isChecking || checkingIndex >= bookmarks.length) {
                finishChecking();
                return;
            }

            const bookmark = bookmarks[checkingIndex];

            // æ›´æ–°å½“å‰ä¹¦ç­¾ä¸ºæ£€æŸ¥ä¸­çŠ¶æ€
            bookmark.status = 'checking';
            updateBookmarkDisplay(bookmark);
            updateProgress();

            try {
                const result = await checkBookmarkWithRetry(bookmark, smartCheck, retryCount);

                bookmark.checked = true;
                bookmark.checkedTime = Date.now(); // è®°å½•æ£€æŸ¥å®Œæˆæ—¶é—´
                bookmark.accessible = result.accessible;
                bookmark.status = result.accessible ? 'accessible' : 'inaccessible';
                bookmark.statusCode = result.status;
                bookmark.statusText = result.statusText;
                bookmark.error = result.error;
                bookmark.deleted = false;

                // æ™ºèƒ½æ£€æŸ¥é€»è¾‘ - æ·»åŠ è¯¦ç»†å»ºè®®ä¿¡æ¯
                if (!result.accessible && smartCheck) {
                    const recommendation = getDeleteRecommendation(result);
                    bookmark.error = `${result.error} (${recommendation.reason})`;
                    bookmark.deleteRecommendation = recommendation;
                } else if (!result.accessible) {
                    bookmark.error = result.error;
                }

                // æ›´æ–°ç»Ÿè®¡
                stats.checked++;
                if (result.accessible) {
                    stats.accessible++;
                } else {
                    stats.inaccessible++;
                }

                updateBookmarkDisplay(bookmark);
                updateStats();

            } catch (error) {
                console.error(`æ£€æŸ¥ä¹¦ç­¾å¤±è´¥ (${bookmark.title}):`, error);
                bookmark.checked = true;
                bookmark.checkedTime = Date.now(); // è®°å½•æ£€æŸ¥å®Œæˆæ—¶é—´
                bookmark.accessible = false;
                bookmark.status = 'inaccessible';
                bookmark.error = error.message;
                stats.checked++;
                stats.inaccessible++;
                updateBookmarkDisplay(bookmark);
                updateStats();
            }

            checkingIndex++;

            // å»¶è¿Ÿåæ£€æŸ¥ä¸‹ä¸€ä¸ª
            if (isChecking) {
                setTimeout(() => checkNextBookmark(smartCheck, retryCount, checkDelay), checkDelay);
            }
        }

        // å¸¦é‡è¯•çš„ä¹¦ç­¾æ£€æŸ¥
        async function checkBookmarkWithRetry(bookmark, smartCheck, maxRetries) {
            let lastResult = null;

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await API.post('/api/system/check-links-stream', {
                        bookmarkId: bookmark.id,
                        url: bookmark.url,
                        attempt: attempt,
                        maxRetries: maxRetries
                    });

                    if (response.success) {
                        lastResult = response.data;

                        // å¦‚æœæˆåŠŸè®¿é—®ï¼Œç›´æ¥è¿”å›
                        if (lastResult.accessible) {
                            return lastResult;
                        }

                        // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œè¿”å›ç»“æœ
                        if (attempt === maxRetries) {
                            return lastResult;
                        }

                        // å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡ï¼Œç­‰å¾…ä¸€ä¸‹å†é‡è¯•
                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    } else {
                        throw new Error(response.error);
                    }
                } catch (error) {
                    lastResult = {
                        accessible: false,
                        status: 0,
                        statusText: 'Network Error',
                        error: error.message
                    };

                    if (attempt < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
            }

            return lastResult;
        }

        // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ é™¤ä¹¦ç­¾ - æ›´æ–°ç‰ˆæœ¬ï¼Œæ›´å¥½åœ°å¤„ç†Cloudflareç­‰æƒ…å†µ
        function shouldDeleteBookmark(result) {
            // å¦‚æœç½‘ç«™å¯è®¿é—®ï¼Œä¸åˆ é™¤
            if (result.accessible) {
                return false;
            }

            // æ˜ç¡®çš„é”™è¯¯ç±»å‹ï¼Œå»ºè®®åˆ é™¤
            const deleteReasons = [
                'åŸŸåä¸å­˜åœ¨',        // åŸŸåç¡®å®ä¸å­˜åœ¨
                'è¿æ¥è¢«æ‹’ç»',        // æœåŠ¡å™¨æ‹’ç»è¿æ¥
                'SSLè¯ä¹¦é—®é¢˜'        // è¯ä¹¦é—®é¢˜
            ];

            // æ˜ç¡®çš„HTTPçŠ¶æ€ç ï¼Œå»ºè®®åˆ é™¤
            const deleteStatusCodes = [
                404, // é¡µé¢ä¸å­˜åœ¨
                410  // é¡µé¢å·²æ°¸ä¹…åˆ é™¤
            ];

            // åº”è¯¥ä¿ç•™çš„æƒ…å†µï¼ˆå¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜æˆ–é˜²æŠ¤æœºåˆ¶ï¼‰
            const keepReasons = [
                'Cloudflareé˜²æŠ¤',    // Cloudflareé˜²æŠ¤
                'è¯·æ±‚è¶…æ—¶',          // å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜
                'ç½‘ç«™å“åº”ç¼“æ…¢',      // å“åº”æ…¢ä½†å¯èƒ½æ­£å¸¸
                'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',    // 500é”™è¯¯å¯èƒ½æ˜¯ä¸´æ—¶çš„
                'ç½‘å…³é”™è¯¯',          // 502é”™è¯¯å¯èƒ½æ˜¯ä¸´æ—¶çš„
                'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',    // 503å¯èƒ½æ˜¯ç»´æŠ¤
                'ç½‘å…³è¶…æ—¶',          // 504å¯èƒ½æ˜¯ä¸´æ—¶çš„
                'è¯·æ±‚è¿‡äºé¢‘ç¹',      // 429é™æµ
                'è®¿é—®è¢«ç¦æ­¢',        // 403å¯èƒ½éœ€è¦ç™»å½•
                'ç½‘ç»œè¿æ¥é—®é¢˜'       // ç½‘ç»œé—®é¢˜
            ];

            // æ£€æŸ¥æ˜¯å¦åº”è¯¥ä¿ç•™
            if (result.error) {
                for (const reason of keepReasons) {
                    if (result.error.includes(reason)) {
                        return false; // å»ºè®®ä¿ç•™
                    }
                }

                // æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ é™¤
                for (const reason of deleteReasons) {
                    if (result.error.includes(reason)) {
                        return true; // å»ºè®®åˆ é™¤
                    }
                }
            }

            // æ£€æŸ¥çŠ¶æ€ç 
            if (deleteStatusCodes.includes(result.status)) {
                return true; // å»ºè®®åˆ é™¤
            }

            // é»˜è®¤æƒ…å†µï¼šå¦‚æœä¸ç¡®å®šï¼Œå»ºè®®ä¿ç•™ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰
            return false;
        }

        // è·å–åˆ é™¤å»ºè®®çš„è¯¦ç»†è¯´æ˜
        function getDeleteRecommendation(result) {
            if (result.accessible) {
                return { shouldDelete: false, reason: 'ç½‘ç«™å¯æ­£å¸¸è®¿é—®' };
            }

            const shouldDelete = shouldDeleteBookmark(result);

            if (shouldDelete) {
                if (result.status === 404) {
                    return { shouldDelete: true, reason: 'é¡µé¢ä¸å­˜åœ¨ï¼Œå»ºè®®åˆ é™¤' };
                }
                if (result.status === 410) {
                    return { shouldDelete: true, reason: 'é¡µé¢å·²æ°¸ä¹…åˆ é™¤ï¼Œå»ºè®®åˆ é™¤' };
                }
                if (result.error && result.error.includes('åŸŸåä¸å­˜åœ¨')) {
                    return { shouldDelete: true, reason: 'åŸŸåä¸å­˜åœ¨ï¼Œå»ºè®®åˆ é™¤' };
                }
                return { shouldDelete: true, reason: 'ç½‘ç«™ç¡®å®å¤±æ•ˆï¼Œå»ºè®®åˆ é™¤' };
            } else {
                if (result.error && result.error.includes('Cloudflareé˜²æŠ¤')) {
                    return { shouldDelete: false, reason: 'Cloudflareé˜²æŠ¤ï¼Œç½‘ç«™æ­£å¸¸ï¼Œå»ºè®®ä¿ç•™' };
                }
                if (result.error && result.error.includes('è¶…æ—¶')) {
                    return { shouldDelete: false, reason: 'ç½‘ç»œè¶…æ—¶ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ï¼Œå»ºè®®ä¿ç•™' };
                }
                if (result.status >= 500) {
                    return { shouldDelete: false, reason: 'æœåŠ¡å™¨é”™è¯¯ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ï¼Œå»ºè®®ä¿ç•™' };
                }
                return { shouldDelete: false, reason: 'å¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ï¼Œå»ºè®®ä¿ç•™' };
            }
        }

        // åœæ­¢æ£€æŸ¥
        function stopLinkCheck() {
            isChecking = false;
            finishChecking();
        }

        // å®Œæˆæ£€æŸ¥
        function finishChecking() {
            isChecking = false;
            document.getElementById('startCheck').classList.remove('hidden');
            document.getElementById('stopCheck').classList.add('hidden');

            updateProgress();

            // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
            const message = `æ£€æŸ¥å®Œæˆï¼æ€»è®¡: ${stats.total}, å¯è®¿é—®: ${stats.accessible}, ä¸å¯è®¿é—®: ${stats.inaccessible}${stats.deleted > 0 ? `, å·²åˆ é™¤: ${stats.deleted}` : ''}`;
            document.getElementById('progressText').textContent = message;

            // æ£€æŸ¥å®Œæˆåé‡æ–°æ˜¾ç¤ºæ‰€æœ‰ä¹¦ç­¾
            displayBookmarks();

            // å¦‚æœæœ‰ä¸å¯è®¿é—®çš„é“¾æ¥ï¼Œæ˜¾ç¤ºæ‰¹é‡åˆ é™¤æŒ‰é’®
            const inaccessibleCount = bookmarks.filter(b => b.status === 'inaccessible' && !b.deleted).length;
            const batchDeleteBtn = document.getElementById('batchDelete');
            if (inaccessibleCount > 0) {
                batchDeleteBtn.classList.remove('hidden');
                batchDeleteBtn.innerHTML = `<span class="btn-icon">ğŸ—‘ï¸</span>åˆ é™¤æ‰€æœ‰æ— æ•ˆé“¾æ¥ (${inaccessibleCount})`;
            } else {
                batchDeleteBtn.classList.add('hidden');
            }
        }

        // æ‰¹é‡åˆ é™¤ä¸å¯è®¿é—®çš„ä¹¦ç­¾
        async function batchDeleteInaccessible() {
            const inaccessibleBookmarks = bookmarks.filter(b => b.status === 'inaccessible' && !b.deleted);

            if (inaccessibleBookmarks.length === 0) {
                showMessage('æ²¡æœ‰éœ€è¦åˆ é™¤çš„æ— æ•ˆé“¾æ¥', 'info');
                return;
            }

            const confirmMessage = `âš ï¸ æ‰¹é‡åˆ é™¤ç¡®è®¤\n\nç¡®å®šè¦åˆ é™¤æ‰€æœ‰ ${inaccessibleBookmarks.length} ä¸ªæ— æ•ˆé“¾æ¥å—ï¼Ÿ\n\nå°†åˆ é™¤ä»¥ä¸‹ä¹¦ç­¾ï¼š\n${inaccessibleBookmarks.slice(0, 5).map(b => `â€¢ ${b.title}`).join('\n')}${inaccessibleBookmarks.length > 5 ? `\n... è¿˜æœ‰ ${inaccessibleBookmarks.length - 5} ä¸ª` : ''}\n\nâš ï¸ é‡è¦æé†’ï¼š\nâ€¢ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\nâ€¢ å»ºè®®å…ˆæ‰‹åŠ¨æ£€æŸ¥å‡ ä¸ªé“¾æ¥ç¡®è®¤\nâ€¢ æŸäº›ç½‘ç«™å¯èƒ½ä¸´æ—¶æ— æ³•è®¿é—®\n\nç¡®å®šç»§ç»­å—ï¼Ÿ`;

            if (!confirm(confirmMessage)) {
                return;
            }

            let deletedCount = 0;
            let failedCount = 0;

            for (const bookmark of inaccessibleBookmarks) {
                try {
                    // å‡†å¤‡åˆ é™¤è¯·æ±‚ï¼ŒåŒ…å«æ£€æŸ¥çŠ¶æ€ä¿¡æ¯
                    const deleteData = {
                        reason: 'batch_delete_inaccessible',
                        checkStatus: bookmark.status,
                        statusCode: bookmark.statusCode,
                        statusText: bookmark.statusText,
                        errorMessage: bookmark.error,
                        keepStatus: bookmark.keepStatus
                    };

                    const response = await API.request(`/api/bookmarks/${bookmark.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(deleteData)
                    });

                    if (response.success) {
                        bookmark.deleted = true;
                        bookmark.status = 'deleted';
                        deletedCount++;
                    } else {
                        failedCount++;
                        console.error(`åˆ é™¤ä¹¦ç­¾å¤±è´¥: ${bookmark.title}`, response.error);
                    }
                } catch (error) {
                    failedCount++;
                    console.error(`åˆ é™¤ä¹¦ç­¾å¤±è´¥: ${bookmark.title}`, error);
                }
            }

            // æ›´æ–°ç»Ÿè®¡
            stats.deleted += deletedCount;
            stats.inaccessible -= deletedCount;

            // æ›´æ–°æ˜¾ç¤º
            updateStats();
            displayBookmarks();

            // éšè—æ‰¹é‡åˆ é™¤æŒ‰é’®
            document.getElementById('batchDelete').classList.add('hidden');

            // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
            if (failedCount === 0) {
                showMessage(`æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªæ— æ•ˆé“¾æ¥`, 'success');
            } else {
                showMessage(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${deletedCount} ä¸ªï¼Œå¤±è´¥ ${failedCount} ä¸ª`, 'info');
            }
        }

        // æ›´æ–°ä¹¦ç­¾æ˜¾ç¤º
        function updateBookmarkDisplay(bookmark) {
            const importantStatusChanges = ['checking', 'accessible', 'inaccessible', 'deleted'];
            if (importantStatusChanges.includes(bookmark.status)) {
                displayBookmarks();
                setTimeout(() => {
                    ensureActionButtonsVisible();
                }, 50);
                return;
            }

            // å¯¹äºéé‡è¦çŠ¶æ€å˜åŒ–ï¼Œåªæ›´æ–°å•ä¸ªå…ƒç´ 
            const bookmarkElement = document.getElementById(`bookmark-${bookmark.id}`);
            const statusElement = document.getElementById(`status-${bookmark.id}`);
            const resultElement = document.getElementById(`result-${bookmark.id}`);

            if (!bookmarkElement) {
                // å¦‚æœå½“å‰ç­›é€‰ä¸‹çœ‹ä¸åˆ°è¿™ä¸ªä¹¦ç­¾ï¼Œé‡æ–°æ˜¾ç¤ºåˆ—è¡¨
                displayBookmarks();
                return;
            }

            // æ›´æ–°ä¹¦ç­¾é¡¹æ ·å¼
            bookmarkElement.className = `bookmark-item ${bookmark.status}`;

            // æ›´æ–°çŠ¶æ€å›¾æ ‡
            statusElement.className = `bookmark-status status-${bookmark.status}`;

            let statusIcon = '';
            let resultText = getResultText(bookmark);

            switch (bookmark.status) {
                case 'pending':
                    statusIcon = bookmarkElement.dataset.index ? parseInt(bookmarkElement.dataset.index) + 1 : '?';
                    break;
                case 'checking':
                    statusIcon = 'â³';
                    break;
                case 'accessible':
                    statusIcon = 'âœ“';
                    break;
                case 'inaccessible':
                    statusIcon = 'âœ—';
                    break;
                case 'deleted':
                    statusIcon = 'ğŸ—‘ï¸';
                    break;
            }

            statusElement.textContent = statusIcon;
            resultElement.textContent = resultText;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            // é‡æ–°è®¡ç®—ç»Ÿè®¡æ•°æ®
            stats.total = bookmarks.length;
            stats.checked = bookmarks.filter(b => b.checked).length;
            stats.accessible = bookmarks.filter(b => b.status === 'accessible').length;
            stats.inaccessible = bookmarks.filter(b => b.status === 'inaccessible' && !b.deleted).length;
            stats.deleted = bookmarks.filter(b => b.deleted || b.status === 'deleted').length;
            stats.kept = bookmarks.filter(b => b.keepStatus === 'keep').length;

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalBookmarks').textContent = stats.total;
            document.getElementById('checkedCount').textContent = stats.checked;
            document.getElementById('accessibleCount').textContent = stats.accessible;
            document.getElementById('inaccessibleCount').textContent = stats.inaccessible;
            document.getElementById('deletedCount').textContent = stats.deleted;
            document.getElementById('keptCount').textContent = stats.kept;
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const percentage = stats.total > 0 ? Math.round((stats.checked / stats.total) * 100) : 0;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercent').textContent = `${percentage}%`;

            if (isChecking && checkingIndex < bookmarks.length) {
                const currentBookmark = bookmarks[checkingIndex];
                document.getElementById('progressText').textContent = `æ­£åœ¨æ£€æŸ¥: ${currentBookmark.title}`;
            }
        }

        // åˆ é™¤å•ä¸ªä¹¦ç­¾
        async function deleteBookmark(bookmarkId) {
            const bookmark = bookmarks.find(b => b.id == bookmarkId); // ä½¿ç”¨ == è€Œä¸æ˜¯ === æ¥å¤„ç†ç±»å‹è½¬æ¢
            if (!bookmark) {
                console.error('æœªæ‰¾åˆ°ä¹¦ç­¾ï¼ŒID:', bookmarkId);
                return;
            }

            if (!confirm(`âš ï¸ åˆ é™¤ç¡®è®¤\n\nç¡®å®šè¦åˆ é™¤ä¹¦ç­¾ "${bookmark.title}" å—ï¼Ÿ\n\nURL: ${bookmark.url}\n\nâš ï¸ æ³¨æ„ï¼š\nâ€¢ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼\nâ€¢ å»ºè®®å…ˆæ‰‹åŠ¨è®¿é—®ç¡®è®¤é“¾æ¥ç¡®å®æ— æ•ˆ\nâ€¢ æŸäº›ç½‘ç«™å¯èƒ½åªæ˜¯ä¸´æ—¶æ— æ³•è®¿é—®\n\nç¡®å®šåˆ é™¤å—ï¼Ÿ`)) {
                return;
            }

            try {
                // å‡†å¤‡åˆ é™¤è¯·æ±‚ï¼ŒåŒ…å«æ£€æŸ¥çŠ¶æ€ä¿¡æ¯
                const deleteData = {
                    reason: bookmark.status === 'inaccessible' ? 'link_check_failed' : 'manual_delete',
                    checkStatus: bookmark.status,
                    statusCode: bookmark.statusCode,
                    statusText: bookmark.statusText,
                    errorMessage: bookmark.error,
                    keepStatus: bookmark.keepStatus
                };

                const response = await API.request(`/api/bookmarks/${bookmarkId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(deleteData)
                });

                if (response.success) {
                    // æ›´æ–°ä¹¦ç­¾çŠ¶æ€ä¸ºå·²åˆ é™¤
                    bookmark.deleted = true;
                    bookmark.status = 'deleted';
                    stats.deleted++;
                    stats.inaccessible--;

                    updateBookmarkDisplay(bookmark);
                    updateStats();
                    displayBookmarks(); // é‡æ–°æ˜¾ç¤ºä»¥æ›´æ–°åˆ é™¤æŒ‰é’®

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`ä¹¦ç­¾ "${bookmark.title}" å·²åˆ é™¤`, 'success');
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(text, type = 'info') {
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1001;
                animation: slideIn 0.3s ease-out;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            `;
            message.textContent = text;

            // æ·»åŠ åŠ¨ç”»æ ·å¼
            if (!document.querySelector('#message-styles')) {
                const style = document.createElement('style');
                style.id = 'message-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(message);

            // è‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                message.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => message.remove(), 300);
            }, 3000);
        }

        // æ ‡è®°ä¹¦ç­¾ä¸ºä¿ç•™
        async function keepBookmark(bookmarkId) {
            const bookmark = bookmarks.find(b => b.id == bookmarkId);
            if (!bookmark) {
                console.error('æœªæ‰¾åˆ°ä¹¦ç­¾ï¼ŒID:', bookmarkId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦æ ‡è®°ä¹¦ç­¾ "${bookmark.title}" ä¸ºä¿ç•™å—ï¼Ÿ\n\næ ‡è®°ä¸ºä¿ç•™åï¼š\nâ€¢ å³ä½¿æ£€æŸ¥å¤±è´¥ä¹Ÿä¸ä¼šå»ºè®®åˆ é™¤\nâ€¢ å¯ä»¥éšæ—¶å–æ¶ˆä¿ç•™æ ‡è®°\nâ€¢ ä»ä¼šå‚ä¸é“¾æ¥æ£€æŸ¥`)) {
                return;
            }

            try {
                const response = await API.post('/api/bookmarks/keep-status', {
                    bookmarkId: bookmarkId,
                    keepStatus: 'keep'
                });

                if (response.success) {
                    // æ›´æ–°ä¹¦ç­¾çŠ¶æ€
                    bookmark.keepStatus = 'keep';

                    // é‡æ–°æ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨
                    displayBookmarks();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`ä¹¦ç­¾ "${bookmark.title}" å·²æ ‡è®°ä¸ºä¿ç•™`, 'success');
                } else {
                    showMessage('æ ‡è®°ä¿ç•™å¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('æ ‡è®°ä¿ç•™å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¶ˆä¹¦ç­¾ä¿ç•™æ ‡è®°
        async function unkeepBookmark(bookmarkId) {
            const bookmark = bookmarks.find(b => b.id == bookmarkId);
            if (!bookmark) {
                console.error('æœªæ‰¾åˆ°ä¹¦ç­¾ï¼ŒID:', bookmarkId);
                return;
            }

            if (!confirm(`ç¡®å®šè¦å–æ¶ˆä¹¦ç­¾ "${bookmark.title}" çš„ä¿ç•™æ ‡è®°å—ï¼Ÿ\n\nå–æ¶ˆåï¼š\nâ€¢ å¦‚æœé“¾æ¥æ£€æŸ¥å¤±è´¥ï¼Œä¼šé‡æ–°å»ºè®®åˆ é™¤\nâ€¢ å¯ä»¥é‡æ–°æ ‡è®°ä¸ºä¿ç•™`)) {
                return;
            }

            try {
                const response = await API.post('/api/bookmarks/keep-status', {
                    bookmarkId: bookmarkId,
                    keepStatus: 'normal'
                });

                if (response.success) {
                    // æ›´æ–°ä¹¦ç­¾çŠ¶æ€
                    bookmark.keepStatus = 'normal';

                    // é‡æ–°æ˜¾ç¤ºä¹¦ç­¾åˆ—è¡¨
                    displayBookmarks();

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage(`ä¹¦ç­¾ "${bookmark.title}" å·²å–æ¶ˆä¿ç•™æ ‡è®°`, 'success');
                } else {
                    showMessage('å–æ¶ˆä¿ç•™å¤±è´¥: ' + response.error, 'error');
                }
            } catch (error) {
                showMessage('å–æ¶ˆä¿ç•™å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function loadHistory() {
            try {
                const response = await API.get('/api/system/check-links');
                if (response.success) {
                    displayHistory(response.data);
                }
            } catch (error) {
                console.error('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="empty-state">æš‚æ— æ£€æŸ¥å†å²</div>';
                return;
            }

            historyList.innerHTML = history.map(record => `
                <div class="history-item">
                    <div class="history-header">
                        <strong>${new Date(record.checkedAt).toLocaleString()}</strong>
                        <div class="history-stats">
                            <span>æ€»è®¡: ${record.total}</span>
                            <span style="color: #28a745;">å¯è®¿é—®: ${record.accessible}</span>
                            <span style="color: #dc3545;">ä¸å¯è®¿é—®: ${record.inaccessible}</span>
                            ${record.autoDelete ? `<span style="color: #ffc107;">å·²åˆ é™¤: ${record.inaccessible}</span>` : ''}
                        </div>
                    </div>
                    <div>
                        ${record.autoDelete ? 'âœ… è‡ªåŠ¨åˆ é™¤å·²å¯ç”¨' : 'âš ï¸ ä»…æ£€æŸ¥ï¼Œæœªåˆ é™¤'}
                    </div>
                </div>
            `).join('');
        }

        function toggleHistory() {
            const historyCard = document.getElementById('historyCard');
            historyCard.classList.toggle('hidden');
        }

        // åˆ‡æ¢è¯´æ˜é¢æ¿
        function toggleExplanation() {
            const content = document.getElementById('explanationContent');
            const toggleText = document.getElementById('explanationToggleText');

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                toggleText.textContent = 'éšè—è¯¦æƒ…';
            } else {
                content.classList.add('hidden');
                toggleText.textContent = 'æ˜¾ç¤ºè¯¦æƒ…';
            }
        }

        // ç­›é€‰ä¹¦ç­¾æ˜¾ç¤º
        function filterBookmarksDisplay(filter) {
            const bookmarkItems = document.querySelectorAll('.bookmark-item');
            let visibleCount = 0;

            bookmarkItems.forEach(item => {
                let shouldShow = false;

                switch (filter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'checked':
                        shouldShow = item.classList.contains('accessible') ||
                                   item.classList.contains('inaccessible') ||
                                   item.classList.contains('kept') ||
                                   item.classList.contains('deleted');
                        break;
                    case 'accessible':
                        shouldShow = item.classList.contains('accessible');
                        break;
                    case 'inaccessible':
                        shouldShow = item.classList.contains('inaccessible');
                        break;
                    case 'deleted':
                        shouldShow = item.classList.contains('deleted');
                        break;
                    case 'kept':
                        shouldShow = item.classList.contains('kept');
                        break;
                }

                if (shouldShow) {
                    item.style.display = 'flex';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });

            // æ›´æ–°ç­›é€‰çŠ¶æ€æ˜¾ç¤º
            const filterStatus = document.getElementById('filterStatus');
            if (filterStatus) {
                if (filter === 'all') {
                    filterStatus.textContent = `æ˜¾ç¤ºå…¨éƒ¨ (${visibleCount})`;
                } else {
                    const filterNames = {
                        'checked': 'å·²æ£€æŸ¥',
                        'accessible': 'å¯è®¿é—®',
                        'inaccessible': 'ä¸å¯è®¿é—®',
                        'deleted': 'å·²åˆ é™¤',
                        'kept': 'å·²ä¿ç•™'
                    };
                    filterStatus.textContent = `ç­›é€‰: ${filterNames[filter]} (${visibleCount})`;
                }
            }
        }
    </script>
</body>
</html>
